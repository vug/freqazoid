<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web Audio API</title>
    <script src="../node_modules/vue/dist/vue.js"></script>
</head>
<body>
<div id="app">
    <div class="param-num">
        <label>x</label>
        <input type="range" min="20" max="2000" v-model.number="x">
        <input type="range" min="20" max="2000" v-model.number="x">
        {{x}}
    </div>

    <div class="param-num">
        <label>gain</label>
        <input type="range" min="0" max="1.0" step="0.01" v-model.number="ae.gain.gain.value">
        <input type="range" min="0" max="1.0" step="0.01" v-model.number="ae.gain.gain.value">
        {{ae.gain.gain.value}}
    </div>

    <div class="param-num">
        <label>frequency</label>
        <input type="range" min="20" max="2000" v-model.number="ae.oscillator.frequency.value">
        <input type="range" min="20" max="2000" v-model.number="ae.oscillator.frequency.value">
        {{ae.oscillator.frequency.value}}
    </div>

    <div class="param-num">
        <label>analyser smoothing time constant</label>
        <input type="range" min="0.0" max="1.0" step="0.01" v-model.number="ae.analyser.smoothingTimeConstant">
        <input type="range" min="0.0" max="1.0" step="0.01" v-model.number="ae.analyser.smoothingTimeConstant">
        {{ae.analyser.smoothingTimeConstant}}
    </div>

    <div class="param-sel">
        <label>type</label>
        <select v-model="ae.oscillator.type">
            <option>sine</option>
            <option>square</option>
            <option>sawtooth</option>
            <option>triangle</option>
            <option>custom</option>
        </select>
    </div>

    <div>
        <label>audioContext</label>
        <button v-on:click="pauseAudioEngine">{{enginePlaying ? 'pause' : 'play'}}</button>
    </div>
</div>

<div id="cnv-osc"></div>
<div id="cnv-spc"></div>

<script>
window.AudioContext = window.AudioContext || window.webkitAudioContext;
class AudioEngine {
    constructor() {
        this.context = new window.AudioContext();

        this.oscillator = this.context.createOscillator();
        this.gain = this.context.createGain();
        this.analyser = this.context.createAnalyser();

        this.oscillator.type = 'sine';
        this.oscillator.frequency.value = 440;
        this.oscillator.start();
        this.gain.gain.value = 0.5;
        this.analyser.smoothingTimeConstant = 0.5;

        this.analyser.fftSize = 2048;

        this.oscillator.connect(this.gain);
        this.oscillator.connect(this.analyser);
        this.gain.connect(this.context.destination);
    }
}

class AudioVisualization {
    constructor(analyser, elemId) {
        this.analyser = analyser;
        this.elemId = elemId;

        this.div = document.getElementById(this.elemId);
        this.div.style.setProperty('outline', 'solid 1px');
        this.div.style.setProperty('display', 'inline-block');
        this.canvas = document.createElement('canvas');
        this.canvas.setAttribute('width', this.analyser.frequencyBinCount);
        this.canvas.setAttribute('height', 300);
        this.div.appendChild(this.canvas);
        this.context = this.canvas.getContext('2d');

        this.buffer = new Float32Array(this.analyser.frequencyBinCount);

        this.animate();
    }

    render() {

    }

    animate() {
        this.render();

        requestAnimationFrame(this.animate.bind(this));
    }
}

class Oscilloscope extends AudioVisualization {
    render() {
        this.analyser.getFloatTimeDomainData(this.buffer);
        var ctx = this.context;
        var width = this.canvas.width;
        var height = this.canvas.height;
        var halfHeight = height * 0.5;

        ctx.clearRect(0, 0, width, height);
        ctx.beginPath();
        ctx.moveTo(0, height / 2);
        for (var x=0; x<this.analyser.frequencyBinCount; x++) {
            var sample = this.buffer[x];
            var y = sample * halfHeight + halfHeight;
            ctx.lineTo(x, y);
        }
        ctx.stroke();
    }
}

class Spectroscope extends AudioVisualization {
    render() {
        this.analyser.getFloatFrequencyData(this.buffer);
        var ctx = this.context;
        var width = this.canvas.width;
        var height = this.canvas.height;

        ctx.clearRect(0, 0, width, height);
        ctx.beginPath();
        ctx.moveTo(0, 0);
        for (var x=0; x<this.buffer.length; x++) {
            var sample = -this.buffer[x];
            var y = sample;
            ctx.lineTo(x, y);
        }
        ctx.stroke();
    }
}

var ae = new AudioEngine();
var osc = new Oscilloscope(ae.analyser, 'cnv-osc');
var spc = new Spectroscope(ae.analyser, 'cnv-spc');
var vue =  new Vue({
    el: '#app',
    data: {
        ae: ae,
        enginePlaying: true,
        x: 100
    },
    methods: {
        pauseAudioEngine: function() {
            if(this.ae.context.state === "running") {
                this.ae.context.suspend();
                this.enginePlaying = false;
            }
            else if(this.ae.context.state === "suspended") {
                this.ae.context.resume();
                this.enginePlaying = true;
            }
        }
    },
    computed: {

    }
});

//var buffer = context.createBuffer(1, 44100, 44100);
//var bufferSource = context.createBufferSource();
</script>
</body>
</html>